#!/usr/bin/env bash
set -e

if [ -z "$1" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    echo "Usage:"
    echo "  gh q get <repo>     ... Clone a repository into ~/ghq/github.com"
    echo "  gh q list           ... List all repositories in ~/ghq/github.com"
    echo "  gh q clean [--days N] [--dry-run]"
    echo "                     ... Clean generated artifacts in ~/ghq older than N days (default 15)"
    echo "  gh q -- <command>   ... Search via fzf and run <command> in the selected directory"
    echo "  gh q <command>      ... Search via fzf and run <command> with selected directory as argument"
    exit 0

# gh q get
elif [ "$1" == "get" ]; then
    if [[ "$2" == git@github.com:* || "$2" == https://github.com/* ]]; then
        # ex: git@github.com:owner/repo.git → owner/repo
        # ex: https:github.com/owner/repo.git → owner/repo
        repo_name=$(echo "$2" | sed -e 's/.*github.com[:\/]\(.*\)\.git/\1/')
        repo_path="$HOME/ghq/github.com/${repo_name}"
    else
        repo_path="$HOME/ghq/github.com/$2"
    fi

    if [ ! -d "$repo_path" ]; then
        gh repo clone "$2" "$repo_path"
    else
        echo "Repository already exists at $repo_path"
    fi


# gh q list
elif [ "$1" == "list" ]; then
    find ~/ghq -maxdepth 3 -mindepth 3 -type d -not -path '*/\.*' -not -path '*/.git/worktrees*'


elif [ "$1" == "clean" ]; then
    shift
    DAYS=15
    DRY_RUN=0
    while [ $# -gt 0 ]; do
        case "$1" in
            --days)
                if [ -n "$2" ] && [[ "$2" =~ ^[0-9]+$ ]]; then
                    DAYS="$2"; shift 2
                else
                    echo "Error: --days requires an integer argument" >&2; exit 1
                fi
                ;;
            --dry-run)
                DRY_RUN=1; shift ;;
            -h|--help)
                echo "Usage: gh q clean [--days N] [--dry-run]";
                echo "  Cleans generated artifacts under ~/ghq older than N days (default 15).";
                echo "  Targets: node_modules, dist, build, out, .next, .nuxt, .cache, .gradle, .terraform, target, .venv, venv, .tox, __pycache__, .pytest_cache, .mypy_cache, coverage, .parcel-cache, .yarn/cache, .yarn/unplugged, Pods";
                exit 0 ;;
            *)
                echo "Unknown option: $1" >&2; exit 1 ;;
        esac
    done

    ROOT="$HOME/ghq"
    if [ ! -d "$ROOT" ]; then
        echo "Not found: $ROOT" >&2; exit 1
    fi

    TARGETS=(
        node_modules
        dist
        build
        out
        .next
        .nuxt
        .cache
        .gradle
        .terraform
        target
        .venv
        venv
        .tox
        __pycache__
        .pytest_cache
        .mypy_cache
        coverage
        .parcel-cache
        Pods
        .yarn
    )

    name_expr=()
    for n in "${TARGETS[@]}"; do
        if [ ${#name_expr[@]} -gt 0 ]; then
            name_expr+=( -o )
        fi
        if [ "$n" = ".yarn" ]; then
            name_expr+=( \( -path "*/.yarn/cache" -o -path "*/.yarn/unplugged" \) )
        else
            name_expr+=( -name "$n" )
        fi
    done

    echo "Scanning $ROOT for generated artifacts older than $DAYS days..."

    if [ $DRY_RUN -eq 1 ]; then
        eval find "\"$ROOT\"" -type d \( ${name_expr[@]} \) -mtime +"$DAYS" -prune -print
        exit 0
    else
        COUNT=0
        # Use process substitution to stay in current shell
        while IFS= read -r d; do
            # Skip empty lines just in case
            [ -z "$d" ] && continue
            if [ $COUNT -eq 0 ]; then
                echo "Found directories to remove:"
            fi
            echo "Removing: $d"
            rm -rf "$d"
            COUNT=$((COUNT+1))
        done < <(eval find "\"$ROOT\"" -type d \( ${name_expr[@]} \) -mtime +"$DAYS" -prune -print)
        if [ $COUNT -eq 0 ]; then
            echo "No candidates found."
        else
            echo "Cleanup complete. Removed $COUNT directories."
        fi
    fi


# gh q -- <command>
elif [ "$1" == "--" ]; then
    shift  # Remove the "--" from arguments
    selected_dir=$(gh q list | fzf)
    if [ -n "$selected_dir" ]; then
        cd "$selected_dir"
        if [ $# -eq 0 ]; then
            exec "$SHELL"
        else
            exec "$@"
        fi
    fi

# gh q <command>
else
    selected_dir=$(gh q list | fzf)
    if [ -n "$selected_dir" ]; then
        exec "$@" "$selected_dir"
    fi
fi
